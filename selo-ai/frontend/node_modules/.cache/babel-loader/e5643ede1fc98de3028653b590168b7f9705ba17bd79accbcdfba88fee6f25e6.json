{"ast":null,"code":"import React,{useState,useRef,useEffect,useCallback}from'react';import{v4 as uuidv4}from'uuid';import ReflectionPanel from'./ReflectionPanel';import{reflectionService}from'../services/reflectionService';import{getApiBaseUrl}from'../services/config';import{formatRelativeTime}from'../utils/dateFormatter';import{io}from'socket.io-client';// Runtime-resolved API base URL\nimport{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";const trimTrailingSlash=s=>s.replace(/\\/$/,'');// Enforce strict reflection-first UX (no assistant release without matching reflection)\nconst STRICT_REFLECTION_FIRST=true;const Chat=_ref=>{let{userId}=_ref;const[messages,setMessages]=useState([]);const[input,setInput]=useState('');const[isLoading,setIsLoading]=useState(false);const[apiBase,setApiBase]=useState(null);// Map of turnId -> assistant message content waiting for matching reflection\nconst pendingAnswersRef=useRef(new Map());const reflectionsSeenRef=useRef(new Set());const[sessionId,setSessionId]=useState(null);// Track per-turn timeouts for releasing pending assistant messages if reflection is delayed\nconst pendingTimeoutsRef=useRef(new Map());const chatSocketRef=useRef(null);const streamingBuffersRef=useRef(new Map());const releasedTurnsRef=useRef(new Set());const setPendingAnswer=useCallback(function(turnId){var _ref2;let{content,timestamp}=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};if(!turnId)return;const existing=pendingAnswersRef.current.get(turnId)||{};const resolvedContent=content!==undefined?content:existing.content;const resolvedTimestamp=(_ref2=timestamp!==null&&timestamp!==void 0?timestamp:existing.timestamp)!==null&&_ref2!==void 0?_ref2:new Date().toISOString();pendingAnswersRef.current.set(turnId,{content:resolvedContent!==undefined?resolvedContent:'',timestamp:resolvedTimestamp});releasedTurnsRef.current.delete(turnId);},[]);const flushPendingAnswer=useCallback(function(turnId){var _pending$content,_ref3,_overrides$timestamp;let overrides=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};if(!turnId||releasedTurnsRef.current.has(turnId))return false;const pending=pendingAnswersRef.current.get(turnId);if(!pending&&overrides.content===undefined&&overrides.timestamp===undefined){return false;}const content=overrides.content!==undefined?overrides.content:(_pending$content=pending===null||pending===void 0?void 0:pending.content)!==null&&_pending$content!==void 0?_pending$content:'';const timestamp=(_ref3=(_overrides$timestamp=overrides.timestamp)!==null&&_overrides$timestamp!==void 0?_overrides$timestamp:pending===null||pending===void 0?void 0:pending.timestamp)!==null&&_ref3!==void 0?_ref3:new Date().toISOString();pendingAnswersRef.current.delete(turnId);const timeoutId=pendingTimeoutsRef.current.get(turnId);if(timeoutId){clearTimeout(timeoutId);pendingTimeoutsRef.current.delete(turnId);}streamingBuffersRef.current.delete(turnId);releasedTurnsRef.current.add(turnId);setMessages(prev=>[...prev,{role:'assistant',content,timestamp}]);return true;},[setMessages]);const messagesEndRef=useRef(null);// Auto-scroll to bottom when messages change\nuseEffect(()=>{var _messagesEndRef$curre;(_messagesEndRef$curre=messagesEndRef.current)===null||_messagesEndRef$curre===void 0?void 0:_messagesEndRef$curre.scrollIntoView({behavior:'smooth'});},[messages]);// Cleanup pending timeouts on unmount to prevent memory leaks\nuseEffect(()=>{return()=>{// Clear all pending timeouts when component unmounts\npendingTimeoutsRef.current.forEach(timeoutId=>{clearTimeout(timeoutId);});pendingTimeoutsRef.current.clear();streamingBuffersRef.current.clear();pendingAnswersRef.current.clear();reflectionsSeenRef.current.clear();releasedTurnsRef.current.clear();if(chatSocketRef.current){try{chatSocketRef.current.disconnect();}catch(_){}chatSocketRef.current=null;}};},[]);// Resolve API base URL at runtime via backend /config.json (with fallbacks inside getApiBaseUrl)\nuseEffect(()=>{let mounted=true;(async()=>{try{const base=await getApiBaseUrl();if(mounted)setApiBase(base);}catch(e){console.warn('Failed to resolve API base URL:',e);if(mounted)setApiBase('http://localhost:8000');}})();return()=>{mounted=false;};},[]);// Establish a single, consistent session id across the app. Prefer App's userId prop.\nuseEffect(()=>{// If App provided a userId, use it and persist to localStorage for continuity\nif(userId&&typeof userId==='string'){setSessionId(userId);try{localStorage.setItem('selo_ai_session_id',userId);}catch(_){}return;}// Fallback to existing persisted session id or create a new one\nlet sid=null;try{sid=localStorage.getItem('selo_ai_session_id');}catch(_){sid=null;}if(!sid){sid=uuidv4();try{localStorage.setItem('selo_ai_session_id',sid);}catch(_){}}setSessionId(sid);},[userId]);// Load conversation history when sessionId is available\nuseEffect(()=>{if(!sessionId||!apiBase)return;const loadConversationHistory=async()=>{try{const response=await fetch(`${trimTrailingSlash(apiBase)}/conversations/history?session_id=${sessionId}`,{method:'GET',headers:{'Content-Type':'application/json'}});if(response.ok){const data=await response.json();if(data.messages&&Array.isArray(data.messages)){// Convert backend message format to frontend format\nconst formattedMessages=data.messages.map(msg=>({role:msg.role==='user'?'user':'assistant',content:msg.content,timestamp:msg.timestamp||null}));setMessages(formattedMessages);}}}catch(error){console.warn('[Chat] Failed to load conversation history:',error);// Don't show error to user, just start with empty conversation\n}};loadConversationHistory();},[sessionId,apiBase]);// Subscribe to reflections: show a visible \"Reflecting…\" indicator during generation and\n// release pending assistant messages when matching turn_id arrives\nuseEffect(()=>{if(!sessionId)return;const unsubscribe=reflectionService.onReflectionGenerated(evt=>{// Reflection service emits both generating and generated events to this listener.\n// evt.status can be 'generating' | 'complete'.\nconst base=evt||{};const payload=(base===null||base===void 0?void 0:base.data)||base;if(!payload)return;const{turn_id,user_profile_id}=payload;if(!turn_id)return;if(user_profile_id&&user_profile_id!==sessionId)return;if(base.status==='complete'){reflectionsSeenRef.current.add(turn_id);const released=flushPendingAnswer(turn_id);if(!released&&pendingAnswersRef.current.size===1){// Fallback: if exactly one pending answer exists for this session but the turn_id didn't match,\n// release it to avoid a stuck UI due to rare id mismatch races.\ntry{console.warn('[Reflect] releasing unmatched pending assistant due to single-pending fallback');}catch(_){}const[[k,v]]=Array.from(pendingAnswersRef.current.entries());flushPendingAnswer(k,{content:v===null||v===void 0?void 0:v.content,timestamp:v===null||v===void 0?void 0:v.timestamp});}}},sessionId);return()=>{if(typeof unsubscribe==='function')unsubscribe();};},[sessionId,flushPendingAnswer]);useEffect(()=>{if(!sessionId||!apiBase)return;const socket=io(`${trimTrailingSlash(apiBase)}/chat`,{path:'/socket.io',transports:['websocket'],upgrade:false,autoConnect:true,reconnection:true,reconnectionAttempts:Infinity,reconnectionDelay:500,reconnectionDelayMax:5000});chatSocketRef.current=socket;socket.on('connect',()=>{try{socket.emit('join',{user_id:sessionId});}catch(_){}});socket.on('chat_chunk',function(){let payload=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};const turnId=payload.turn_id||payload.turnId;const chunk=payload.chunk;if(!turnId||typeof chunk!=='string'||chunk.length===0)return;const previous=streamingBuffersRef.current.get(turnId)||'';const combined=previous+chunk;streamingBuffersRef.current.set(turnId,combined);setPendingAnswer(turnId,{content:combined,timestamp:payload.timestamp||new Date().toISOString()});if(payload.final&&reflectionsSeenRef.current.has(turnId)){flushPendingAnswer(turnId,{content:combined,timestamp:payload.timestamp});}});socket.on('chat_complete',function(){let payload=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};const turnId=payload.turn_id||payload.turnId;if(!turnId)return;const content=typeof payload.content==='string'?payload.content:'';const timestamp=payload.timestamp||new Date().toISOString();streamingBuffersRef.current.delete(turnId);setPendingAnswer(turnId,{content,timestamp});if(reflectionsSeenRef.current.has(turnId)){flushPendingAnswer(turnId,{content,timestamp});}});return()=>{socket.off('connect');socket.off('chat_chunk');socket.off('chat_complete');try{socket.disconnect();}catch(_){}if(chatSocketRef.current===socket){chatSocketRef.current=null;}streamingBuffersRef.current.clear();};},[sessionId,apiBase,flushPendingAnswer,setPendingAnswer]);const clearConversation=()=>{setMessages([]);// Optionally generate a new session ID to start fresh\nconst newSessionId=uuidv4();setSessionId(newSessionId);try{localStorage.setItem('selo_ai_session_id',newSessionId);}catch(_){}pendingAnswersRef.current.clear();reflectionsSeenRef.current.clear();releasedTurnsRef.current.clear();streamingBuffersRef.current.clear();pendingTimeoutsRef.current.forEach(timeoutId=>{clearTimeout(timeoutId);});pendingTimeoutsRef.current.clear();};const handleSubmit=async e=>{e.preventDefault();if(!input.trim()||isLoading||!apiBase||!sessionId)return;const nowIso=new Date().toISOString();const userMessage={role:'user',content:input,timestamp:nowIso};setMessages(prev=>[...prev,userMessage]);setInput('');setIsLoading(true);try{const CHAT_ENDPOINT=`${trimTrailingSlash(apiBase)}/chat`;// Debug logging removed for production\nconst response=await fetch(CHAT_ENDPOINT,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({session_id:sessionId,prompt:input})});if(!response.ok){const text=await response.text().catch(()=>'');try{console.error('[Chat] /chat non-OK',response.status,text);}catch(_){}throw new Error('Network response was not ok');}const data=await response.json();// Debug logging removed for production\nconst turnId=data.turn_id;const assistantContent=data.response;const assistantTimestamp=data.timestamp||new Date().toISOString();// Prefer showing reflection first. Gate assistant until matching reflection arrives,\n// but fall back after a short timeout to prevent indefinite blocking.\nif(turnId){if(reflectionsSeenRef.current.has(turnId)){setMessages(prev=>[...prev,{role:'assistant',content:assistantContent,timestamp:assistantTimestamp}]);}else{setPendingAnswer(turnId,{content:assistantContent,timestamp:assistantTimestamp});if(!STRICT_REFLECTION_FIRST){const timeoutId=setTimeout(()=>{if(pendingAnswersRef.current.has(turnId)){const pending=pendingAnswersRef.current.get(turnId);pendingAnswersRef.current.delete(turnId);pendingTimeoutsRef.current.delete(turnId);setMessages(prev=>[...prev,{role:'assistant',content:(pending===null||pending===void 0?void 0:pending.content)||assistantContent,timestamp:(pending===null||pending===void 0?void 0:pending.timestamp)||assistantTimestamp}]);}},8000);pendingTimeoutsRef.current.set(turnId,timeoutId);}}}else{// No turn_id returned, show immediately\nsetMessages(prev=>[...prev,{role:'assistant',content:assistantContent,timestamp:assistantTimestamp}]);}}catch(error){console.error('[Chat] submit error:',error);setMessages(prev=>[...prev,{role:'assistant',content:'Sorry, there was an error processing your request. Please try again.',timestamp:new Date().toISOString()}]);}finally{setIsLoading(false);}};return/*#__PURE__*/_jsxs(\"div\",{className:\"flex h-full w-full\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"flex flex-col flex-1 h-full max-w-2xl min-w-0\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"flex-1 overflow-y-auto p-4 space-y-4 mb-4\",children:[!apiBase?/*#__PURE__*/_jsx(\"div\",{className:\"flex items-center justify-center h-full\",children:/*#__PURE__*/_jsx(\"div\",{className:\"text-center text-gray-500\",children:/*#__PURE__*/_jsx(\"p\",{className:\"text-sm\",children:\"Loading configuration...\"})})}):messages.length===0?/*#__PURE__*/_jsx(\"div\",{className:\"flex items-center justify-center h-full\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"text-center text-gray-500\",children:[/*#__PURE__*/_jsx(\"p\",{className:\"text-lg mb-2\",children:\"Welcome to SELO DSP\"}),/*#__PURE__*/_jsx(\"p\",{className:\"text-sm\",children:\"Start a conversation with your SELO\"})]})}):messages.map((message,index)=>{const displayTime=formatRelativeTime(message.timestamp);return/*#__PURE__*/_jsx(\"div\",{className:`flex ${message.role==='user'?'justify-end':'justify-start'}`,children:/*#__PURE__*/_jsxs(\"div\",{className:`max-w-[75%] rounded-lg p-4 ${message.role==='user'?'bg-[var(--color-bg-elev-1)] border border-[var(--color-accent)]/40 text-white':'bg-[var(--color-bg-elev-1)] border border-[var(--color-border)] text-[var(--color-text-secondary)]'}`,children:[/*#__PURE__*/_jsx(\"div\",{className:\"whitespace-pre-wrap\",children:message.content}),/*#__PURE__*/_jsx(\"div\",{className:\"mt-2 text-xs text-[var(--color-text-muted)] text-right\",children:displayTime})]})},index);}),isLoading&&/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center space-x-2 text-[var(--color-accent)]\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"w-2 h-2 bg-[var(--color-accent)] rounded-full animate-pulse\"}),/*#__PURE__*/_jsx(\"div\",{className:\"w-2 h-2 bg-[var(--color-accent)] rounded-full animate-pulse delay-150\"}),/*#__PURE__*/_jsx(\"div\",{className:\"w-2 h-2 bg-[var(--color-accent)] rounded-full animate-pulse delay-300\"}),/*#__PURE__*/_jsx(\"span\",{className:\"ml-2 text-sm\",children:\"SELO DSP is thinking...\"})]}),/*#__PURE__*/_jsx(\"div\",{ref:messagesEndRef})]}),/*#__PURE__*/_jsx(\"form\",{onSubmit:handleSubmit,className:\"mt-4\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"flex space-x-2\",children:[/*#__PURE__*/_jsx(\"input\",{type:\"text\",value:input,onChange:e=>setInput(e.target.value),placeholder:\"Type your message...\",className:\"flex-1 bg-[var(--color-bg-elev-1)] border border-[var(--color-border)] rounded-lg px-4 py-2 text-white focus:outline-none\",disabled:isLoading}),messages.length>0&&/*#__PURE__*/_jsx(\"button\",{type:\"button\",onClick:clearConversation,className:\"px-4 py-2 bg-[var(--color-bg-elev-1)] hover:bg-[var(--color-bg-elev-2)] text-gray-400 hover:text-white border border-[var(--color-border)] rounded-lg font-medium transition-colors\",title:\"Clear conversation\",children:\"Clear\"}),/*#__PURE__*/_jsx(\"button\",{type:\"submit\",disabled:!input.trim()||isLoading,className:\"px-6 py-2 bg-[var(--color-bg-elev-1)] hover:bg-[var(--color-bg-elev-2)] text-[var(--color-accent)] border border-[var(--color-accent)]/50 rounded-lg font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed\",children:\"Send\"})]})})]}),/*#__PURE__*/_jsx(\"div\",{className:\"hidden md:block md:w-[420px] md:min-w-[320px] md:max-w-[520px] h-full border-l border-[var(--color-border)] bg-[var(--color-bg-elev-1)]\",children:/*#__PURE__*/_jsx(ReflectionPanel,{sessionId:sessionId,messages:messages})})]});};export default Chat;","map":{"version":3,"names":["React","useState","useRef","useEffect","useCallback","v4","uuidv4","ReflectionPanel","reflectionService","getApiBaseUrl","formatRelativeTime","io","jsx","_jsx","jsxs","_jsxs","trimTrailingSlash","s","replace","STRICT_REFLECTION_FIRST","Chat","_ref","userId","messages","setMessages","input","setInput","isLoading","setIsLoading","apiBase","setApiBase","pendingAnswersRef","Map","reflectionsSeenRef","Set","sessionId","setSessionId","pendingTimeoutsRef","chatSocketRef","streamingBuffersRef","releasedTurnsRef","setPendingAnswer","turnId","_ref2","content","timestamp","arguments","length","undefined","existing","current","get","resolvedContent","resolvedTimestamp","Date","toISOString","set","delete","flushPendingAnswer","_pending$content","_ref3","_overrides$timestamp","overrides","has","pending","timeoutId","clearTimeout","add","prev","role","messagesEndRef","_messagesEndRef$curre","scrollIntoView","behavior","forEach","clear","disconnect","_","mounted","base","e","console","warn","localStorage","setItem","sid","getItem","loadConversationHistory","response","fetch","method","headers","ok","data","json","Array","isArray","formattedMessages","map","msg","error","unsubscribe","onReflectionGenerated","evt","payload","turn_id","user_profile_id","status","released","size","k","v","from","entries","socket","path","transports","upgrade","autoConnect","reconnection","reconnectionAttempts","Infinity","reconnectionDelay","reconnectionDelayMax","on","emit","user_id","chunk","previous","combined","final","off","clearConversation","newSessionId","handleSubmit","preventDefault","trim","nowIso","userMessage","CHAT_ENDPOINT","body","JSON","stringify","session_id","prompt","text","catch","Error","assistantContent","assistantTimestamp","setTimeout","className","children","message","index","displayTime","ref","onSubmit","type","value","onChange","target","placeholder","disabled","onClick","title"],"sources":["/mnt/local/Projects/SELODSP1/selo-ai/frontend/src/components/Chat.jsx"],"sourcesContent":["import React, { useState, useRef, useEffect, useCallback } from 'react';\nimport { v4 as uuidv4 } from 'uuid';\nimport ReflectionPanel from './ReflectionPanel';\nimport { reflectionService } from '../services/reflectionService';\nimport { getApiBaseUrl } from '../services/config';\nimport { formatRelativeTime } from '../utils/dateFormatter';\nimport { io } from 'socket.io-client';\n\n// Runtime-resolved API base URL\nconst trimTrailingSlash = (s) => s.replace(/\\/$/, '');\n// Enforce strict reflection-first UX (no assistant release without matching reflection)\nconst STRICT_REFLECTION_FIRST = true;\n\nconst Chat = ({ userId }) => {\n  const [messages, setMessages] = useState([]);\n  const [input, setInput] = useState('');\n  const [isLoading, setIsLoading] = useState(false);\n  const [apiBase, setApiBase] = useState(null);\n  // Map of turnId -> assistant message content waiting for matching reflection\n  const pendingAnswersRef = useRef(new Map());\n  const reflectionsSeenRef = useRef(new Set());\n  const [sessionId, setSessionId] = useState(null);\n  // Track per-turn timeouts for releasing pending assistant messages if reflection is delayed\n  const pendingTimeoutsRef = useRef(new Map());\n  const chatSocketRef = useRef(null);\n  const streamingBuffersRef = useRef(new Map());\n  const releasedTurnsRef = useRef(new Set());\n\n  const setPendingAnswer = useCallback((turnId, { content, timestamp } = {}) => {\n    if (!turnId) return;\n    const existing = pendingAnswersRef.current.get(turnId) || {};\n    const resolvedContent = content !== undefined ? content : existing.content;\n    const resolvedTimestamp = timestamp ?? existing.timestamp ?? new Date().toISOString();\n    pendingAnswersRef.current.set(turnId, {\n      content: resolvedContent !== undefined ? resolvedContent : '',\n      timestamp: resolvedTimestamp,\n    });\n    releasedTurnsRef.current.delete(turnId);\n  }, []);\n\n  const flushPendingAnswer = useCallback((turnId, overrides = {}) => {\n    if (!turnId || releasedTurnsRef.current.has(turnId)) return false;\n    const pending = pendingAnswersRef.current.get(turnId);\n    if (!pending && overrides.content === undefined && overrides.timestamp === undefined) {\n      return false;\n    }\n    const content = overrides.content !== undefined ? overrides.content : (pending?.content ?? '');\n    const timestamp = overrides.timestamp ?? pending?.timestamp ?? new Date().toISOString();\n    pendingAnswersRef.current.delete(turnId);\n    const timeoutId = pendingTimeoutsRef.current.get(turnId);\n    if (timeoutId) {\n      clearTimeout(timeoutId);\n      pendingTimeoutsRef.current.delete(turnId);\n    }\n    streamingBuffersRef.current.delete(turnId);\n    releasedTurnsRef.current.add(turnId);\n    setMessages(prev => [...prev, {\n      role: 'assistant',\n      content,\n      timestamp,\n    }]);\n    return true;\n  }, [setMessages]);\n  \n  const messagesEndRef = useRef(null);\n\n  // Auto-scroll to bottom when messages change\n  useEffect(() => {\n    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });\n  }, [messages]);\n\n  // Cleanup pending timeouts on unmount to prevent memory leaks\n  useEffect(() => {\n    return () => {\n      // Clear all pending timeouts when component unmounts\n      pendingTimeoutsRef.current.forEach(timeoutId => {\n        clearTimeout(timeoutId);\n      });\n      pendingTimeoutsRef.current.clear();\n      streamingBuffersRef.current.clear();\n      pendingAnswersRef.current.clear();\n      reflectionsSeenRef.current.clear();\n      releasedTurnsRef.current.clear();\n      if (chatSocketRef.current) {\n        try { chatSocketRef.current.disconnect(); } catch (_) {}\n        chatSocketRef.current = null;\n      }\n    };\n  }, []);\n\n  // Resolve API base URL at runtime via backend /config.json (with fallbacks inside getApiBaseUrl)\n  useEffect(() => {\n    let mounted = true;\n    (async () => {\n      try {\n        const base = await getApiBaseUrl();\n        if (mounted) setApiBase(base);\n      } catch (e) {\n        console.warn('Failed to resolve API base URL:', e);\n        if (mounted) setApiBase('http://localhost:8000');\n      }\n    })();\n    return () => { mounted = false; };\n  }, []);\n\n  // Establish a single, consistent session id across the app. Prefer App's userId prop.\n  useEffect(() => {\n    // If App provided a userId, use it and persist to localStorage for continuity\n    if (userId && typeof userId === 'string') {\n      setSessionId(userId);\n      try { localStorage.setItem('selo_ai_session_id', userId); } catch (_) {}\n      return;\n    }\n    // Fallback to existing persisted session id or create a new one\n    let sid = null;\n    try { sid = localStorage.getItem('selo_ai_session_id'); } catch (_) { sid = null; }\n    if (!sid) {\n      sid = uuidv4();\n      try { localStorage.setItem('selo_ai_session_id', sid); } catch (_) {}\n    }\n    setSessionId(sid);\n  }, [userId]);\n\n  // Load conversation history when sessionId is available\n  useEffect(() => {\n    if (!sessionId || !apiBase) return;\n    \n    const loadConversationHistory = async () => {\n      try {\n        const response = await fetch(`${trimTrailingSlash(apiBase)}/conversations/history?session_id=${sessionId}`, {\n          method: 'GET',\n          headers: {\n            'Content-Type': 'application/json',\n          },\n        });\n        \n        if (response.ok) {\n          const data = await response.json();\n          if (data.messages && Array.isArray(data.messages)) {\n            // Convert backend message format to frontend format\n            const formattedMessages = data.messages.map(msg => ({\n              role: msg.role === 'user' ? 'user' : 'assistant',\n              content: msg.content,\n              timestamp: msg.timestamp || null,\n            }));\n            setMessages(formattedMessages);\n          }\n        }\n      } catch (error) {\n        console.warn('[Chat] Failed to load conversation history:', error);\n        // Don't show error to user, just start with empty conversation\n      }\n    };\n    \n    loadConversationHistory();\n  }, [sessionId, apiBase]);\n\n  // Subscribe to reflections: show a visible \"Reflecting…\" indicator during generation and\n  // release pending assistant messages when matching turn_id arrives\n  useEffect(() => {\n    if (!sessionId) return;\n    const unsubscribe = reflectionService.onReflectionGenerated((evt) => {\n      // Reflection service emits both generating and generated events to this listener.\n      // evt.status can be 'generating' | 'complete'.\n      const base = evt || {};\n      const payload = base?.data || base;\n      if (!payload) return;\n      const { turn_id, user_profile_id } = payload;\n      if (!turn_id) return;\n      if (user_profile_id && user_profile_id !== sessionId) return;\n\n      if (base.status === 'complete') {\n        reflectionsSeenRef.current.add(turn_id);\n        const released = flushPendingAnswer(turn_id);\n        if (!released && pendingAnswersRef.current.size === 1) {\n          // Fallback: if exactly one pending answer exists for this session but the turn_id didn't match,\n          // release it to avoid a stuck UI due to rare id mismatch races.\n          try { console.warn('[Reflect] releasing unmatched pending assistant due to single-pending fallback'); } catch (_) {}\n          const [[k, v]] = Array.from(pendingAnswersRef.current.entries());\n          flushPendingAnswer(k, {\n            content: v?.content,\n            timestamp: v?.timestamp,\n          });\n        }\n      }\n    }, sessionId);\n\n    return () => {\n      if (typeof unsubscribe === 'function') unsubscribe();\n    };\n  }, [sessionId, flushPendingAnswer]);\n\n  useEffect(() => {\n    if (!sessionId || !apiBase) return;\n\n    const socket = io(`${trimTrailingSlash(apiBase)}/chat`, {\n      path: '/socket.io',\n      transports: ['websocket'],\n      upgrade: false,\n      autoConnect: true,\n      reconnection: true,\n      reconnectionAttempts: Infinity,\n      reconnectionDelay: 500,\n      reconnectionDelayMax: 5000,\n    });\n    chatSocketRef.current = socket;\n\n    socket.on('connect', () => {\n      try {\n        socket.emit('join', { user_id: sessionId });\n      } catch (_) {}\n    });\n\n    socket.on('chat_chunk', (payload = {}) => {\n      const turnId = payload.turn_id || payload.turnId;\n      const chunk = payload.chunk;\n      if (!turnId || typeof chunk !== 'string' || chunk.length === 0) return;\n\n      const previous = streamingBuffersRef.current.get(turnId) || '';\n      const combined = previous + chunk;\n      streamingBuffersRef.current.set(turnId, combined);\n\n      setPendingAnswer(turnId, {\n        content: combined,\n        timestamp: payload.timestamp || new Date().toISOString(),\n      });\n\n      if (payload.final && reflectionsSeenRef.current.has(turnId)) {\n        flushPendingAnswer(turnId, {\n          content: combined,\n          timestamp: payload.timestamp,\n        });\n      }\n    });\n\n    socket.on('chat_complete', (payload = {}) => {\n      const turnId = payload.turn_id || payload.turnId;\n      if (!turnId) return;\n\n      const content = typeof payload.content === 'string' ? payload.content : '';\n      const timestamp = payload.timestamp || new Date().toISOString();\n\n      streamingBuffersRef.current.delete(turnId);\n      setPendingAnswer(turnId, { content, timestamp });\n\n      if (reflectionsSeenRef.current.has(turnId)) {\n        flushPendingAnswer(turnId, { content, timestamp });\n      }\n    });\n\n    return () => {\n      socket.off('connect');\n      socket.off('chat_chunk');\n      socket.off('chat_complete');\n      try { socket.disconnect(); } catch (_) {}\n      if (chatSocketRef.current === socket) {\n        chatSocketRef.current = null;\n      }\n      streamingBuffersRef.current.clear();\n    };\n  }, [sessionId, apiBase, flushPendingAnswer, setPendingAnswer]);\n\n  const clearConversation = () => {\n    setMessages([]);\n    // Optionally generate a new session ID to start fresh\n    const newSessionId = uuidv4();\n    setSessionId(newSessionId);\n    try { \n      localStorage.setItem('selo_ai_session_id', newSessionId); \n    } catch (_) {}\n    pendingAnswersRef.current.clear();\n    reflectionsSeenRef.current.clear();\n    releasedTurnsRef.current.clear();\n    streamingBuffersRef.current.clear();\n    pendingTimeoutsRef.current.forEach(timeoutId => {\n      clearTimeout(timeoutId);\n    });\n    pendingTimeoutsRef.current.clear();\n  };\n\n  const handleSubmit = async (e) => {\n    e.preventDefault();\n    if (!input.trim() || isLoading || !apiBase || !sessionId) return;\n\n    const nowIso = new Date().toISOString();\n    const userMessage = { role: 'user', content: input, timestamp: nowIso };\n    setMessages(prev => [...prev, userMessage]);\n    setInput('');\n    setIsLoading(true);\n\n    try {\n      const CHAT_ENDPOINT = `${trimTrailingSlash(apiBase)}/chat`;\n      // Debug logging removed for production\n      const response = await fetch(CHAT_ENDPOINT, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          session_id: sessionId,\n          prompt: input,\n        }),\n      });\n\n      if (!response.ok) {\n        const text = await response.text().catch(() => '');\n        try { console.error('[Chat] /chat non-OK', response.status, text); } catch (_) {}\n        throw new Error('Network response was not ok');\n      }\n\n      const data = await response.json();\n      // Debug logging removed for production\n      const turnId = data.turn_id;\n      const assistantContent = data.response;\n      const assistantTimestamp = data.timestamp || new Date().toISOString();\n      // Prefer showing reflection first. Gate assistant until matching reflection arrives,\n      // but fall back after a short timeout to prevent indefinite blocking.\n      if (turnId) {\n        if (reflectionsSeenRef.current.has(turnId)) {\n          setMessages(prev => [...prev, { role: 'assistant', content: assistantContent, timestamp: assistantTimestamp }]);\n        } else {\n          setPendingAnswer(turnId, { content: assistantContent, timestamp: assistantTimestamp });\n          if (!STRICT_REFLECTION_FIRST) {\n            const timeoutId = setTimeout(() => {\n              if (pendingAnswersRef.current.has(turnId)) {\n                const pending = pendingAnswersRef.current.get(turnId);\n                pendingAnswersRef.current.delete(turnId);\n                pendingTimeoutsRef.current.delete(turnId);\n                setMessages(prev => [...prev, { role: 'assistant', content: pending?.content || assistantContent, timestamp: pending?.timestamp || assistantTimestamp }]);\n              }\n            }, 8000);\n            pendingTimeoutsRef.current.set(turnId, timeoutId);\n          }\n        }\n      } else {\n        // No turn_id returned, show immediately\n        setMessages(prev => [...prev, { role: 'assistant', content: assistantContent, timestamp: assistantTimestamp }]);\n      }\n    } catch (error) {\n      console.error('[Chat] submit error:', error);\n      setMessages(prev => [...prev, {\n        role: 'assistant',\n        content: 'Sorry, there was an error processing your request. Please try again.',\n        timestamp: new Date().toISOString(),\n      }]);\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  return (\n    <div className=\"flex h-full w-full\">\n      {/* Chat panel (left) */}\n      <div className=\"flex flex-col flex-1 h-full max-w-2xl min-w-0\">\n        <div className=\"flex-1 overflow-y-auto p-4 space-y-4 mb-4\">\n          {!apiBase ? (\n            <div className=\"flex items-center justify-center h-full\">\n              <div className=\"text-center text-gray-500\">\n                <p className=\"text-sm\">Loading configuration...</p>\n              </div>\n            </div>\n          ) : messages.length === 0 ? (\n            <div className=\"flex items-center justify-center h-full\">\n              <div className=\"text-center text-gray-500\">\n                <p className=\"text-lg mb-2\">Welcome to SELO DSP</p>\n                <p className=\"text-sm\">Start a conversation with your SELO</p>\n              </div>\n            </div>\n          ) : (\n            messages.map((message, index) => {\n              const displayTime = formatRelativeTime(message.timestamp);\n              return (\n                <div\n                  key={index}\n                  className={`flex ${message.role === 'user' ? 'justify-end' : 'justify-start'}`}\n                >\n                  <div\n                    className={`max-w-[75%] rounded-lg p-4 ${\n                      message.role === 'user'\n                        ? 'bg-[var(--color-bg-elev-1)] border border-[var(--color-accent)]/40 text-white'\n                        : 'bg-[var(--color-bg-elev-1)] border border-[var(--color-border)] text-[var(--color-text-secondary)]'\n                    }`}\n                  >\n                    <div className=\"whitespace-pre-wrap\">{message.content}</div>\n                    <div className=\"mt-2 text-xs text-[var(--color-text-muted)] text-right\">{displayTime}</div>\n                  </div>\n                </div>\n              );\n            })\n          )}\n          {isLoading && (\n            <div className=\"flex items-center space-x-2 text-[var(--color-accent)]\">\n              <div className=\"w-2 h-2 bg-[var(--color-accent)] rounded-full animate-pulse\"></div>\n              <div className=\"w-2 h-2 bg-[var(--color-accent)] rounded-full animate-pulse delay-150\"></div>\n              <div className=\"w-2 h-2 bg-[var(--color-accent)] rounded-full animate-pulse delay-300\"></div>\n              <span className=\"ml-2 text-sm\">SELO DSP is thinking...</span>\n            </div>\n          )}\n          <div ref={messagesEndRef} />\n        </div>\n        {/* Input area */}\n        <form onSubmit={handleSubmit} className=\"mt-4\">\n          <div className=\"flex space-x-2\">\n            <input\n              type=\"text\"\n              value={input}\n              onChange={(e) => setInput(e.target.value)}\n              placeholder=\"Type your message...\"\n              className=\"flex-1 bg-[var(--color-bg-elev-1)] border border-[var(--color-border)] rounded-lg px-4 py-2 text-white focus:outline-none\"\n              disabled={isLoading}\n            />\n            {messages.length > 0 && (\n              <button\n                type=\"button\"\n                onClick={clearConversation}\n                className=\"px-4 py-2 bg-[var(--color-bg-elev-1)] hover:bg-[var(--color-bg-elev-2)] text-gray-400 hover:text-white border border-[var(--color-border)] rounded-lg font-medium transition-colors\"\n                title=\"Clear conversation\"\n              >\n                Clear\n              </button>\n            )}\n            <button\n              type=\"submit\"\n              disabled={!input.trim() || isLoading}\n              className=\"px-6 py-2 bg-[var(--color-bg-elev-1)] hover:bg-[var(--color-bg-elev-2)] text-[var(--color-accent)] border border-[var(--color-accent)]/50 rounded-lg font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed\"\n            >\n              Send\n            </button>\n          </div>\n        </form>\n      </div>\n      {/* Reflection panel (right). Hidden on small screens to avoid overflow. */}\n      <div className=\"hidden md:block md:w-[420px] md:min-w-[320px] md:max-w-[520px] h-full border-l border-[var(--color-border)] bg-[var(--color-bg-elev-1)]\">\n        <ReflectionPanel sessionId={sessionId} messages={messages} />\n      </div>\n    </div>\n  );\n};\n\nexport default Chat;\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}